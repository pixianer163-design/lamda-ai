# HKTech Agent 架构文档

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        HKTech Agent v1.4.6                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  Data Layer │    │   LLM Layer │    │  World Model│         │
│  │             │    │             │    │             │         │
│  │ Yahoo/新浪  │───→│ DeepSeek    │───→│ RSSM        │         │
│  │ 实时数据    │    │ 信号提取    │    │ 预测5天     │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│         │                  │                  │                 │
│         └──────────────────┼──────────────────┘                 │
│                            ↓                                   │
│                   ┌─────────────────┐                          │
│                   │ Decision Engine │                          │
│                   │ 决策引擎        │                          │
│                   └────────┬────────┘                          │
│                            ↓                                   │
│                   ┌─────────────────┐                          │
│                   │  Risk Manager   │                          │
│                   │ 风控系统        │                          │
│                   └────────┬────────┘                          │
│                            ↓                                   │
│                   ┌─────────────────┐                          │
│                   │  Execution      │                          │
│                   │ 模拟交易执行    │                          │
│                   └────────┬────────┘                          │
│                            ↓                                   │
│                   ┌─────────────────┐                          │
│                   │  Feishu Notify  │                          │
│                   │ 飞书交互式卡片  │                          │
│                   └─────────────────┘                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. 数据采集 (data_collector.py)

**职责**: 获取实时股票数据

**数据源**:
- 优先级1: Yahoo Finance
- 优先级2: 新浪财经
- 回退: 模拟数据（带警告）

**输出**:
```python
{
    "00700": {
        "price": 386.79,
        "change_pct": 0.52,
        "ma5": 379.05,
        "ma20": 367.45,
        "rsi": 47.73,
        "volume": 1234567,
        "data_source": "yahoo_finance"
    }
}
```

### 2. RSSM世界模型 (rssm_world_model.py)

**架构**:
```
Observation (15维) → Encode → State → Predict → Future Return
```

**关键组件**:
- RNN (递归网络): 记住过去
- SSM (状态空间): 预测未来
- 训练: 自监督学习历史数据

**预测输出**:
```python
{
    "horizon": 5,              # 预测5天
    "cumulative_return": 0.01, # 累计收益1%
    "confidence": 0.90,        # 置信度90%
    "recommendation": "持有"   # 建议
}
```

### 3. LLM信号提取 (llm_signal_extractor.py)

**功能**:
- 读取财经新闻
- 提取情绪信号 (0-1)
- 每只股票独立分析

**输出**:
```python
{
    "00700_sentiment": 0.60,  # 腾讯: 偏乐观
    "09988_sentiment": 0.45,  # 阿里: 偏悲观
    "03690_sentiment": 0.53   # 美团: 中性
}
```

### 4. LLM决策增强 (llm_decision_enhancer.py)

**输入**:
- 技术指标信号
- 世界模型预测
- 新闻情绪信号

**输出**:
- 综合判断 (BUY/SELL/HOLD)
- 风险提示
- 决策理由

### 5. 风控系统 (risk_manager.py)

**规则**:
- 单股最大仓位: 40%
- 总仓位上限: 80%
- 最小现金比例: 20%
- 止损: -8%
- 止盈: +15%

### 6. Agent Factory (agent_factory.py)

**A/B测试配置**:

| Agent | 策略 | 风险 | 股票 | 止损/止盈 |
|-------|------|------|------|----------|
| A-基础版 | 多因子 | 中等 | 3只 | -8%/+15% |
| B-保守版 | 价值 | 低 | 2只 | -5%/+10% |
| C-激进版 | 动量 | 高 | 4只 | -12%/+25% |

## 数据流

```
9:30 Cron触发
    │
    ▼
┌──────────────┐
│ 数据采集     │ ← Yahoo/新浪API
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 世界模型预测 │ ← RSSM预测5天收益
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ LLM信号提取  │ ← 新闻情绪分析
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ LLM决策增强  │ ← 综合判断
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 风控检查     │ ← 仓位/止损检查
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 生成报告     │ ← Markdown格式
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 飞书推送     │ ← 交互式卡片
└──────────────┘
```

## 部署架构

```
阿里云ECS
├── 8080端口 (Nginx/直接)
│   ├── / → Web监控面板
│   ├── /web/docs → 文档中心
│   └── /webhook/feishu → 飞书回调
│
├── 18789端口 (OpenClaw Gateway)
│   └── 内部API
│
├── Cron定时任务
│   └── 9:30运行Agent
│
└── 数据持久化
    ├── /opt/hktech-agent/data/ (本地)
    └── 阿里云OSS (云端备份)
```

## Web服务

### 8080端口服务

| 路径 | 功能 | 文件 |
|------|------|------|
| `/` | 监控面板 | web/index.html |
| `/web/docs/` | 文档中心 | web/docs/index.html |
| `/*.md` | Markdown渲染 | start_web_server.py |
| `/webhook/feishu/hktech` | 飞书回调 | feishu_webhook_handler.py |

## 监控与日志

**日志位置**:
```
/opt/hktech-agent/prod/logs/
├── run_YYYYMMDD_HHMMSS.log  # 运行日志
└── cron.log                  # Cron日志
```

**监控地址**:
- Web面板: http://60.205.245.131:8080/
- 实时状态: 看板展示组合价值、持仓、交易信号

## 演进路线

### v1.x (当前)
- ✅ RSSM世界模型
- ✅ LLM决策增强
- ✅ 飞书推送
- ✅ A/B测试

### v2.0 (规划中)
- 📝 DPML元学习世界模型 (Agent_Factory项目)
- 📝 DSL策略引擎
- 📝 云端训练管道
- 📝 多市场支持 (美股/A股)

---

*文档版本: v1.0*  
*更新日期: 2026-02-19*  
*作者: Alex*
